%!TEX root = paper.tex
\section{Preserving Determinism}


In order to preserve a deterministic semantics for parallel tuples in the presence of exception handling we would like to make it seem to the programmer as if canceled threads ``never happened'' in the first place.  Implementing this for a purely functional language is not too difficult, however, in the presence of shared references such as IVars, it becomes substantially more complex.  

The first step is to ``undo'' the effects of a thread when it is being canceled due to a raised exception.  With IVars this simply amounts to resetting the contents of full IVars to empty.  However, it is possible that before the cancelation occurred, other threads concurrently running were able to read the contents of this IVar.  In this case, the runtime system must also rollback these threads to the point in which they read from the IVar.  At this point, we also need to ``undo'' any effects that these threads may have done and rollback any threads that might have read from these IVars. This rollback continues until we reset all IVars and dependent readers that are transitively reachable from the effects done by the original thread that was canceled.  

As an example of this transitive closure property, consider the code in Figure \ref{transitive}.  In line 4 we fork a new thread to evaluate a parallel tuple that raises an exception and writes the value 10 to IVar $i$.  The thread writing to the IVar is then canceled due to the raised exception, requiring the contents of $i$ to be reset to empty.  In line 6 we read the value written to $i$ and write it into $j$.  If this read occurs before the cancelation, then we must reset this thread back to before it performed the read.  If we are going to reset this thread to before it did the read, then we must also ``undo'' the write to IVar $j$.  Furthermore, if the second element of the parallel tuple is able to read from $j$, then this must also get rolled back to the point before it performed the read.  

\begin{figure}
\lstinputlisting[numbers=left, xleftmargin=5.0ex, morekeywords=fork]{programs/transitive.pml}
\caption{Transitive Rollback}
\label{transitive}
\end{figure}







