%% %%%%% typing of type-indexed operators %%%%%

\newcommand{\tySub}{
  \unnaxiom
  {
    \hastype{\Fsub{\tau}}{\TFun{\TPair{\tau}{\TInt}}{(\select{\tau})}}
  }
  {
    ty-sub
  }
}

\newcommand{\tyFilt}{
  \unnjudgment
  {
    \tau_2 \in A(\tau_1)
  }
  {
    \hastype{\FfiltOp{\tau_1}{\tau_2}}{\TFun{\TPair{\TFun{\tau_1}{\TBool}}{\tau_2}}{\tau_2}}
  }
  {
    ty-filt
  }
}

\newcommand{\tyMap}{
  \unnjudgment
  {
    \tau_3 \in A(\tau_1)
  }
  {
    \hastype{\FmapOp{\tau_1}{\tau_2}{\tau_3}}
            {\TFun{\TPair{\TFun{\tau_1}{\tau_2}}{\tau_3}}{\contain{\tau_3}{\tau_2}}}
  }
  {
    ty-map
  }
}

\newcommand{\tyRed}{
  \unnjudgment
  {
    \tau_2 \in A(\tau_1)
  }
  {
    \hastype{\FreduceOp{\tau_1}{\tau_2}}{\TFun{(\TFun{\tau_1}{\tau_1},\tau_1,\tau_2)}{\tau_1}}
  }
  {
    ty-red
  }
}

%%%%% well-formedness (static semantics) %%%%%

\newcommand{\okVar}{
  \unnjudgment
  {
    \Gamma(\Fvar{x}) = \tau
  }
  { 
    \proves{\Gamma}{\wf{\Ftyp{\Fvar{x}}{\tau}}}
  }
  {
    ok-var
  }
}

\newcommand{\okBase}{
  \unnjudgment
  {
    \textit{BE}(b) = \tau
    \hbump
    \textrm{(\textit{BE} = basis env)}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{b}{\tau}}}
  }
  {
    ok-b
  }
}

\newcommand{\okIf}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_1}{\TBool}}}
    \hbump
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_2}{\tau}}}
    \hbump
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_3}{\tau}}}
  }
  {
    \proves{\Gamma}
           {\wf{\Ftyp{(\Fif{\Ftyp{\Fexp_1}{\TBool}}
                           {\Ftyp{\Fexp_2}{\tau}}
                           {\Ftyp{\Fexp_3}{\tau}})}
               {\tau}}}
  }
  {
    ok-if
  }
}

\newcommand{\okLet}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_1}{\tau_1}}
    \hbump
    \proves{\extend{\Gamma}{\Fvar{x}}{\tau_1}}{\wf{\Ftyp{\Fexp_2}{\tau_2}}}}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{(\Nlet{\Fvar{x}}{\Ftyp{\Fexp_1}{\tau_1}}{\Ftyp{\Fexp_2}{\tau_2}})}
                   {\tau_2}}}
  }
  {
    ok-let
  }
}

\newcommand{\okPair}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_1}{\tau_1}}}
    \hbump
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_2}{\tau_2}}}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fpair{\Ftyp{\Fexp_1}{\tau_1}}{\Ftyp{\Fexp_2}{\tau_2}}}
                       {\TPair{\tau_1}{\tau_2}}}}
  }
  {
    ok-pair
  }
}

\newcommand{\okProj}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp}{\TPair{\tau_1}{\tau_2}}}}
    \hbump
    i \in \{1,2\}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{(\Fproj{i}{\Ftyp{\Fexp}{\TPair{\tau_1}{\tau_2}}})}{\tau_i}}}
  }
  {
    ok-proj
  }
}

\newcommand{\okEArr}{
  \unnaxiom
  {
    \proveswf{\Gamma}{\Ftyp{\Fparr{}}{\TParr{\tau}}}
  }
  {
    ok-e
  }
}

\newcommand{\okArr}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\tau}
    \quad \cdots \quad
    \stdwf{\Fexp_n}{\tau}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fparr{\Es{\Ftyp{\Fexp_1}{\tau}}{\Ftyp{\Fexp_n}{\tau}}}}{\TParr{\tau}}}}
  }
  {
    ok-arr
  }
}

\newcommand{\okEFarr}{ 
  \unnaxiom
  {
    \proveswf{\Gamma}{\Ftyp{\Ffprempty{}}{\TFParr{\tau}{\nu}}}
  }
  {
    ok-f
  }
}

\newcommand{\okFarr}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\tau}
    \quad \cdots \quad
    \stdwf{\Fexp_n}{\tau}
    \hbump
    \shapety{s}{\nu}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{\Ffpr{\Es{\Ftyp{\Fexp_1}{\tau}}{\Ftyp{\Fexp_n}{\tau}}}{s}}{\TFParr{\tau}{\nu}}}}
  }
  {
    ok-farr
  }
}

\newcommand{\okFun}{
  \unnjudgment
  {
    \Gamma' = {\extend{\Gamma}{\Fvar{f}}{\TFun{\tau_0}{\tau_1}}}
    \hbump
    \proves{\extend{\Gamma'}{\Fvar{x}}{\tau_0}}
           {\wf{\Ftyp{\Fexp_1}{\tau_1}}}
    \hbump
    \proves{\Gamma'}
           {\wf{\Ftyp{\Fexp_2}{\tau_2}}}
  }
  {
    \proves{\Gamma}
           {\wf{\Ftyp{(\Ffun{\Fvar{f}}
                            {\Fvar{x}}
                            {\tau_0}
                            {\Ftyp{\Fexp_1}{\tau_1}}
                            {\Ftyp{\Fexp_2}{\tau_2}})}
               {\tau_2}}}
  }
  {
    ok-fun
  }
}

\newcommand{\okApp}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_1}{\TFun{\tau_1}{\tau_2}}}}
    \hbump
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_2}{\tau_1}}}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{(\Fapp{\Ftyp{\Fexp_1}{\TFun{\tau_1}{\tau_2}}}{\Ftyp{\Fexp_2}{\tau_1}})}{\tau_2}}}
  }
  {
    ok-app
  }
}

\newcommand{\okCompose}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_1}{\TFun{\tau_2}{\tau_3}}}}
    \hbump
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_2}{\TFun{\tau_1}{\tau_2}}}}
  }
  {
    \proves{\Gamma}{\wf{\FtypP{\compose{\Ftyp{\Fexp_1}{\TFun{\tau_2}{\tau_3}}}{\Ftyp{\Fexp_2}{\TFun{\tau_1}{\tau_2}}}}
                       {\TFun{\tau_1}{\tau_3}}}}
  }
  {
    ok-comp
  }
}

\newcommand{\okCoerceJTop}{
  \wfc{\tau}{\flt{\tau}}  
}

\newcommand{\okCoerceJBot}{
  \proves{\Gamma}{\wf{\Ftyp{(\Fcoerce{\tau}{\flt{\tau}})}{\TFun{\tau}{\flt{\tau}}}}}
}

\newcommand{\okCoerceJ}{
  \judgment{\okCoerceJTop}
           {\okCoerceJBot}
}

\newcommand{\okCoerce}{
  \unnjudgment{\okCoerceJTop} 
            {\okCoerceJBot}
            {ok-coerce}
}

\newcommand{\okSub}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_1}{\tau}}}
    \hbump
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_2}{\TInt}}}
    \hbump
    \tau' = (\select{\tau})
  }
  {
    \gwf{\FtypP{\Fsub{\tau}{\Ftyp{\Fexp_1}{\tau}}{\Ftyp{\Fexp_2}{\TInt}}}
               {\tau'}}
    %\proves{\Gamma}{\wf{\Ftyp{(\Fsub{\tau}{\stdtyp{1}{1}}{\stdtyp{2}{2}})}{\tau'}}}
  }
  {
    ok-sub
  }
}

\newcommand{\okSubS}{
  \unnjudgment
  {
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_1}{\TParr{\tau}}}}
    \hbump
    \proves{\Gamma}{\wf{\Ftyp{\Fexp_2}{\TInt}}}
  }
  {
    \proves{\Gamma}{\wf{\Ftyp{(\Fsub{\TParr{\tau}}
                                    {\Ftyp{\Fexp_1}{\TParr{\tau}}}
                                    {\Ftyp{\Fexp_2}{\TInt}})}
                             {\tau}}}
  }
  {
    ok-sub-s
  }
}

\newcommand{\okMap}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\TFun{\tau_1}{\tau_2}}
    \hbump
    \stdwf{\Fexp_2}{\tau_3}
    \hbump
    \relA{\tau_3}{\tau_1}
    \hbump
    \relA{\tau_4}{\tau_2}
  }
  {
    \stdwfP{\Fmap{\tau_1}
                 {\tau_2}
                 {\tau_3}
                 {\tau_4}
                 {\Ftyp{\Fexp_1}{\TFun{\tau_1}{\tau_2}}}
                 {\Ftyp{\Fexp_2}{\tau_3}}}
           {\tau_4}
  }
  {
    ok-map
  }
}

\newcommand{\okMapS}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\TFun{\tau_1}{\tau_2}}
    \hbump
    \stdwf{\Fexp_2}{\TParr{\tau_1}}
  }
  {
    \stdwfP{\Fmap{\tau_1}
                 {\tau_2}
                 {\TParr{\tau_1}}
                 {\TParr{\tau_2}}
                 {\Ftyp{\Fexp_1}{\TFun{\tau_1}{\tau_2}}}
                 {\Ftyp{\Fexp_2}{\TParr{\tau_1}}}}
           {\TParr{\tau_2}}
  }
  {
    ok-map-s
  }
}

\newcommand{\okFilt}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\TFun{\tau_1}{\TBool}}
    \hbump
    \stdwf{\Fexp_2}{\tau_2}
    \hbump
    \relA{\tau_2}{\tau_1}
  }
  {
    \stdwfP{\Ffilt{\tau_1}
                  {\tau_2}
                  {\Ftyp{\Fexp_1}{\TFun{\tau_1}{\TBool}}}
                  {\Ftyp{\Fexp_2}{\tau_2}}}
           {\tau_2}
  }
  {
    ok-filt
  }
}

\newcommand{\okFiltS}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\TFun{\tau_1}{\TBool}}
    \hbump
    \stdwf{\Fexp_2}{\TParr{\tau_1}}
  }
  {
    \stdwfP{\Ffilt{\tau_1}
                  {\TParr{\tau_1}}
                  {\Ftyp{\Fexp_1}{\TFun{\tau_1}{\TBool}}}
                  {\Ftyp{\Fexp_2}{\TParr{\tau_1}}}}
           {\TParr{\tau_1}}
  }
  {
    ok-filt-s
  }
}

\newcommand{\okRed}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\TAssocOp{\tau_1}}
    \hbump
    \stdwf{\Fexp_2}{\tau_1}
    \hbump
    \stdwf{\Fexp_3}{\tau_2}
    \hbump
    \relA{\tau_2}{\tau_1}
  }
  {
    \stdwfP{\Freduce{\tau_1}
                    {\tau_2}
                    {\Ftyp{\Fexp_1}{\TAssocOp{\tau_1}}}
                    {\Ftyp{\Fexp_2}{\tau_1}}
                    {\Ftyp{\Fexp_3}{\tau_2}}}
           {\tau_1}
  }
  {
    ok-red
  }
}

\newcommand{\okRedS}{
  \unnjudgment
  {
    \stdwf{\Fexp_1}{\TAssocOp{\tau_1}}
    \hbump
    \stdwf{\Fexp_2}{\tau_1}
    \hbump
    \stdwf{\Fexp_3}{\TParr{\tau_1}}
  }
  {
    \stdwfP{\Freduce{\tau_1}
                    {\TParr{\tau_1}}
                    {\Ftyp{\Fexp_1}{\TAssocOp{\tau_1}}}
                    {\Ftyp{\Fexp_2}{\tau_1}}
                    {\Ftyp{\Fexp_3}{\TParr{\tau_1}}}}
           {\tau_1}
  }
  {
    ok-red-s
  }
}

%%%%% well-formedness for coercions %%%%%

\newcommand{\coID}{
  \unnaxiom
  {
    \wfc{\tau}{\tau}
  }
  {
    co-id
  }
}

\newcommand{\coFL}{
  \unnaxiom
  {
    \wfc{\TParr{\tau}}{\TFParr{\tau}{\TLf}}
  }
  {
    co-fl
  }
}

\newcommand{\coFR}{
  \unnaxiom
  {
    \wfc{\TFParr{\tau}{\TLf}}{\TParr{\tau}}
  }
  {
    co-fr
  }
}

\newcommand{\coLL}{
  \unnaxiom
  {
    \wfc{\TFParr{\tau}{\TNd{\nu}}}{\TFParr{\TFParr{\tau}{\nu}}{\TLf}}
  }
  {
    co-ll
  }
}

\newcommand{\coLR}{
  \unnaxiom
  {
    \wfc{\TFParr{\TFParr{\tau}{\nu}}{\TLf}}{\TFParr{\tau}{\TNd{\nu}}}
  }
  {
    co-lr
  }
}

\newcommand{\coNL}{
  \unnaxiom
  {
    \wfc
      {\TFParr{\TFParr{\tau}{\TNd{\nu}}}{\nu'}}
      {\TFParr{\TFParr{\tau}{\nu}}{\TNd{\nu'}}}
  }
  {
    co-nl
  }
}

\newcommand{\coNR}{
  \unnaxiom
  {
    \wfc
      {\TFParr{\TFParr{\tau}{\nu}}{\TNd{\nu'}}}
      {\TFParr{\TFParr{\tau}{\TNd{\nu}}}{\nu'}}
  }
  {
    co-nr
  }
}

\newcommand{\coZL}{
  \unnaxiom
  {
    \wfc{\TParr{\TPair{\tau_1}{\tau_2}}}
        {\TPair{\TParr{\tau_1}}{\TParr{\tau_2}}}         
  }
  {
    co-zl
  }
}

\newcommand{\coZR}{
  \unnaxiom
  {
    \wfc{\TPair{\TParr{\tau_1}}{\TParr{\tau_2}}}
        {\TParr{\TPair{\tau_1}{\tau_2}}}
  }
  {
    co-zr
  }
}

\newcommand{\coZFL}{
  \unnaxiom
  {
    \wfc{\TFParr{\TPair{\tau_1}{\tau_2}}{\nu}}
        {\TPair{\TFParr{\tau_1}{\nu}}{\TFParr{\tau_2}{\nu}}}
  }
  {
    co-zfl
  }
}

\newcommand{\coZFR}{
  \unnaxiom
  {
    \wfc{\TPair{\TFParr{\tau_1}{\nu}}{\TFParr{\tau_2}{\nu}}}
        {\TFParr{\TPair{\tau_1}{\tau_2}}{\nu}}
  }
  {
    co-zfr
  }
}

\newcommand{\coA}{
  \unnjudgment
  {
    \wfc{\tau}{\ftau}
  }
  {
    \wfc{\TParr{\tau}}{\TParr{\ftau}}
  }
  {
    co-a
  }
}

\newcommand{\coF}{
  \unnjudgment
  {
    \wfc{\tau}{\ftau}
  }
  {
    \wfc{\TFParr{\tau}{\nu}}{\TFParr{\ftau}{\nu}}
  }
  {
    co-f
  }
}

\newcommand{\coFun}{
  \unnjudgment
  {
    \wfc{\tau_1}{\ftau_1}
    \hbump
    \wfc{\tau_2}{\ftau_2}
  }
  {
    \wfc{(\TFun{\tau_1}{\tau_2})}
        {(\TFun{\ftau_1}{\ftau_2})}
  }
  {
    co-fun
  }
}

\newcommand{\coPair}{
  \unnjudgment
  {
    \wfc{\tau_1}{\ftau_1}
    \hbump
    \wfc{\tau_2}{\ftau_2}
  }
  {
    \wfc{\TPair{\tau_1}{\tau_2}}
        {\TPair{\ftau_1}{\ftau_2}}
  }
  {
    co-pair
  }
}

\newcommand{\coTrans}{
  \unnjudgment
  {
    \wfc{\tau_1}{\tau_2}
    \hbump 
    \wfc{\tau_2}{\tau_3}
  }
  {
    \wfc{\tau_1}{\tau_3}
  }
  {
    co-trans
  }
}

%%%%% big-step flattening %%%%%

\newcommand{\bigBase}{
  \unnaxiom
  {
    \bigstepD{b}{\tau}{b}{\tau}
  }
  {
    b-base 
  }
}

\newcommand{\bigVar}{
  \unnjudgment
  {
    \Delta(\Ftyp{\Fvar{x}}{\tau}) = \Ftyp{\flt{\Fvar{x}}}{\ftau}
  }
  {
    \bigstepD{\Fvar{x}}{\tau}{\flt{\Fvar{x}}}{\ftau}
  }
  {
    b-var
  }
}

\newcommand{\bigIf}{
  \unnjudgment
  {
    \begin{array}{c}
      \bigstepD{\Fexp_1}{\TBool}{\flt{\Fexp}_1}{\TBool} \\
      \bigstepD{\Fexp_2}{\tau}{\Flexp_2}{\ftau} \\
      \bigstepD{\Fexp_2}{\tau}{\Flexp_2}{\ftau}
    \end{array}
  }
  {
    \bigstepLn{\Delta}
              {\Fif{\Ftyp{\Fexp_1}{\TBool}}{\Ftyp{\Fexp_2}{\tau}}{\Ftyp{\Fexp_3}{\tau}}}
              {\tau}
              {\Fif{\Ftyp{\Flexp_1}{\TBool}}{\Ftyp{\Flexp_2}{\ftau}}{\Ftyp{\Flexp_3}{\ftau}}}
              {\ftau}
  }
  {
    b-if
  }
}

\newcommand{\bigLetJTop}{
    \begin{array}{c}
      \bigstep{\Delta}{\Fexp_1}{\tau_1}{\Flexp_1}{\ftau_1} \\
      \Delta' = \Delta[\Ftyp{\Fvar{x}}{\tau_1}
                       \mapsto
                       \Ftyp{\flt{\Fvar{x}}}{\ftau_1}],\ 
                \fresh{\flt{\Fvar{x}}} \\
      \bigstep{\Delta'}{\Fexp_2}{\tau_2}{\Flexp_2}{\ftau_2} \\
    \end{array}
}

\newcommand{\bigLetJBot}{
    \bigstepLn{\Delta}
              {(\Nlet{\Fvar{x}}
                     {\stdtyp{1}{1}}
                     {\stdtyp{2}{2}})}   
              {\tau_2}
              {(\Nlet{\flt{\Fvar{x}}}
                     {\Ftyp{\Flexp_1}{\ftau_1}}
                     {\Ftyp{\Flexp_2}{\ftau_2}})}
              {\ftau_2}
}

\newcommand{\bigLetJ}{
  \judgment{\bigLetJTop}
           {\bigLetJBot}
}

\newcommand{\bigLet}{
  \unnjudgment{\bigLetJTop}
            {\bigLetJBot}
            {b-let}
}

\newcommand{\bigFun}{
  \unnjudgment
  {
    \begin{array}{c}
      \Delta' = \Delta[\Ftyp{\Fvar{f}}{\TFun{\tau_0}{\tau_1}}
                       \mapsto
                       \Ftyp{\flt{\Fvar{f}}}{\TFun{\ftau_0}{\ftau_1}}],\ 
                \fresh{\flt{\Fvar{f}}} \\
      \Delta'' = \Delta'[\Ftyp{\Fvar{x}}{\tau_0}
                         \mapsto
                         \Ftyp{\flt{\Fvar{x}}}{\ftau_0}],\ 
                \fresh{\flt{\Fvar{x}}} \\
      \bigstep{\Delta''}{\Fexp_1}{\tau_1}{\Flexp_1}{\ftau_1} \\
      \bigstep{\Delta'}{\Fexp_2}{\tau_2}{\Flexp_2}{\ftau_2} \\
    \end{array}
  }
  {
    \bigstepLn{\Delta}
              {\Ffun{f}{x}{\tau_0}{\stdtyp{1}{1}}{\stdtyp{2}{2}}}
              {\tau_2}
              {\Ffun{\flt{\Fvar{f}}}
                    {\flt{\Fvar{x}}}
                    {\ftau_0}
                    {\Ftyp{\Flexp_1}{\ftau_1}}
                    {\Ftyp{\Flexp_2}{\ftau_2}}}
             {\ftau_2}
  }
  {
    b-fun
  }
}

\newcommand{\bigPair}{
  \unnjudgment
  {
    \begin{array}{c}
    \stdbig{1}{1} \\
    \stdbig{2}{2} \\
    \end{array}
  }
  {
    \bigstepLn{\Delta}
              {\Fpair{\Ftyp{\Fexp_1}{\tau_1}}{\Ftyp{\Fexp_2}{\tau_2}}}
              {\TPair{\tau_1}{\tau_2}}
              {\Fpair{\Ftyp{\Flexp_1}{\ftau_1}}{\Ftyp{\Flexp_2}{\ftau_2}}}
              {\TPair{\ftau_1}{\ftau_2}}
  }
  {
    b-pair
  }
}

\newcommand{\bigFst}{
  \unnjudgment
  {
    \bigstepD{\Fexp}
             {\TPair{\tau_1}{\tau_2}}
             {\Flexp}
             {\TPair{\ftau_1}{\ftau_2}}
  }
  {
    \bigstepDP{\Fproj{1}{\Ftyp{\Fexp}{\TPair{\tau_1}{\tau_2}}}}
              {\tau_1}
              {\Fproj{1}{\Ftyp{\Flexp}{\TPair{\ftau_1}{\ftau_2}}}}
              {\ftau_1}
  }
  {
    b-fst
  }
}

\newcommand{\bigApp}{
  \unnjudgment
  {
    \begin{array}{c}
      \bigstepD{\Fexp_1}
               {\TFun{\tau_1}{\tau_2}}
               {\Flexp_1}
               {\TFun{\ftau_1}{\ftau_2}} \\
      \bigstepD{\Fexp_2}
               {\tau_1}
               {\Flexp_2}
               {\ftau_1}
    \end{array}
  }
  {
    \bigstepDP{\Fapp{\Ftyp{\Fexp_1}{\TFun{\tau_1}{\tau_2}}}{\Ftyp{\Fexp_2}{\tau_1}}}
              {\tau_2}
              {\Fapp{\Ftyp{\Flexp_1}{\TFun{\ftau_1}{\ftau_2}}}{\Ftyp{\Flexp_2}{\ftau_1}}}
              {\ftau_2}
  }
  {
    b-app
  }
}

\newcommand{\bigEmp}{
  \unnjudgment
  {
    \tau \ftrxty \flt{\tau}
  }
  {
    \Ftyp{\Fparr{}}{\tau} 
    \ftrx 
    \FtypP{\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Ftyp{\Ffprempty}{\flt{\tau}}}}{\tau}
  }
  {
    b-emp
  }
}

\newcommand{\bigArrJTop}{
  \ftyfn{\TParr{\tau}} = \ftau
}

\newcommand{\bigArrJBot}{
  \bigstepD{\Fexp}
           {\TParr{\tau}}
           {(\FappP{\CO{\TParr{\tau}}{\ftau}}{\Ftyp{\Fexp}{\TParr{\tau}}})}
           {\ftau}
}

\newcommand{\bigArrJ}{
  \judgment{\bigArrJTop}
           {\bigArrJBot}
}

\newcommand{\bigArr}{
  \unnjudgment{\bigArrJTop}
            {\bigArrJBot}
            {b-arr}
}

\newcommand{\bigComp}{
  \unnjudgment
  {
    \begin{array}{l}
      \bigstepD{\Fexp_1}
               {\TFun{\tau_2}{\tau_3}}
               {\Flexp_1}
               {\TFun{\ftau_2}{\ftau_3}} \\
      \bigstepD{\Fexp_2}
               {\TFun{\tau_1}{\tau_2}}
               {\Flexp_2}
               {\TFun{\ftau_1}{\ftau_2}}
    \end{array}
  }
  {
    \bigstepDP{\Fcomp{\Fexp_1}{\Fexp_2}}
              {\TFun{\tau_1}{\tau_3}}
              {\Fcomp{\Flexp_1}{\Flexp_2}}
              {\TFun{\ftau_1}{\ftau_3}}
  }
  {
    b-comp
  }
}

\newcommand{\bigSub}{
  \unnjudgment
  {
    \bigstepD{\Fexp_1}{\tau}{\Flexp_1}{\ftau}
    \hbump
    \bigstepD{\Fexp_2}{\TInt}{\Flexp_2}{\TInt}
  }
  {
    \bigstepDP{\Fsub{\tau}{\stdtyp{1}{}}{\Ftyp{\Fexp_2}{\TInt}}}
              {(\select{\tau})}
              {\Fsub{\ftau}{\Ftyp{\Flexp_1}{\ftau}}{\Ftyp{\Flexp_2}{\TInt}}}
              {(\select{\ftau})}
  }
  {
    b-sub
  }
}

\newcommand{\bigMap}{
  \unnjudgment
  {
    \begin{array}{c}
      \bigstepD{\Fexp_1}
               {\TFun{\tau_1}{\tau_2}}
               {\Flexp_1}
               {\TFun{\ftau_1}{\ftau_2}} \\
      \bigstepD{\Fexp_2}
               {\tau_3}
               {\Flexp_2}
               {\ftau_3} \\
      \ftyfn{\tau_4} = \ftau_4
    \end{array}
  }
  {
    \begin{array}{l}
      \Delta \turnstile
        \FtypP{\Fmap{\tau_1}{\tau_2}{\tau_3}{\tau_4}
                    {\Ftyp{\Fexp_1}{\TFun{\tau_1}{\tau_2}}}
                    {\Ftyp{\Fexp_2}{\tau_3}}}
              {\tau_4} \\              
      \quad \ftrx 
      (\CO{\ftau_4}{\tau_4}) \diamond 
        \FtypP{\Fmap{\ftau_1}{\ftau_2}{\ftau_3}{\ftau_4}
                    {\Ftyp{\Flexp_1}{\TFun{\ftau_1}{\ftau_2}}}
                    {\Ftyp{\Flexp_2}{\ftau_3}}}
              {\ftau_4}
    \end{array}
  }
  {
    b-map
  }
}

\newcommand{\bigFilt}{
  \unnjudgment
  {
    \begin{array}{c}
      \bigstepD{\Fexp_1}
               {\TFun{\tau_1}{\TBool}}
               {\Flexp_1}
               {\TFun{\ftau_1}{\TBool}} \\
      \stdbig{2}{2}
    \end{array}
  }
  {
    \begin{array}{l}
      \Delta \turnstile
        \FtypP{\Ffilt{\tau_1}{\tau_2}
                      {\Ftyp{\Fexp_1}{\TFun{\tau_1}{\TBool}}}
                      {\Ftyp{\Fexp_2}{\tau_2}}}
              {\tau_2} \\
      \quad \ftrx 
      (\CO{\ftau_2}{\tau_2}) \diamond 
        \FtypP{\Ffilt{\ftau_1}{\ftau_2}
                     {\Ftyp{\Flexp_1}{\TFun{\ftau_1}{\TBool}}}
                     {\Ftyp{\Flexp_2}{\ftau_2}}}
              {\ftau_2}
    \end{array}
  }
  {
    b-filt
  }
}

\newcommand{\bigReduce}{
  \unnjudgment
  {
    \begin{array}{c}
      \bigstepLn{\Delta}
                {\Fexp_1}
                {\TAssocOp{\tau_1}}
                {\Flexp_1}
                {\TAssocOp{\ftau_1}} \\
      \bigstepD{\Fexp_2}
               {\tau_1}
               {\Flexp_2}
               {\ftau_1} \\
      \bigstepD{\Fexp_3}
               {\tau_2}
               {\Flexp_3}
               {\ftau_2}
    \end{array}
  }
  {
    \begin{array}{l}
      \Delta \turnstile
        \FtypP{\Freduce{\tau_1}
                       {\tau_2}
                       {\Ftyp{\Fexp_1}{\TAssocOp{\tau_1}}}
                       {\Ftyp{\Fexp_2}{\tau_1}}
                       {\Ftyp{\Fexp_3}{\tau_2}}}
              {\tau_2} \\
      \quad \ftrx 
      (\CO{\ftau_2}{\tau_2}) \diamond 
        \FtypP{\Freduce{\ftau_1}
                       {\ftau_2}
                       {\Ftyp{\Flexp_1}{\TAssocOp{\ftau_1}}}
                       {\Ftyp{\Flexp_2}{\ftau_1}}
                       {\Ftyp{\Flexp_3}{\ftau_2}}}
              {\ftau_2}
    \end{array}
  }
  {
    b-red
  }
}

\newcommand{\BIGJTop}{
  \bigstep{\{\}}
          {\Fexp}
          {\tau}
          {\Flexp}
          {\ftau}
}

\newcommand{\BIGJBot}{
  \Ftyp{\Fexp}{\tau}
  \Downarrow
  \FtypP{\FappP{\CO{\ftau}{\tau}}{\Ftyp{\Flexp}{\ftau}}}{\tau}
}

\newcommand{\BIGJ}{
  \judgment{\BIGJTop}
           {\BIGJBot}
}

\newcommand{\BIG}{
  \unnjudgment{\BIGJTop}
            {\BIGJBot}
            {flatten}
}

%%%%% coercion distribution %%%%%

\newcommand{\cdUnfoldCompose}{
  \unnaxiom
  {
    \Fapp{\Fterm_1}({\Fapp{\Fterm_2}{\Fterm_3}}) 
    \ssfttm 
    \Fapp{(\compose{\Fterm_1}{\Fterm_2})}{\Fterm_3}
  }
  {
    cd-cu
  }
}

\newcommand{\cdFoldCompose}{
  \unnaxiom
  {
    \Fapp{(\compose{\Fterm_1}{\Fterm_2})}{\Fterm_3}
    \ssfttm 
    \Fapp{\Fterm_1}({\Fapp{\Fterm_2}{\Fterm_3}}) 
  }
  {
    cd-cf
  }
}

\newcommand{\cdIDIntroJBot}{
  \Ftyp{\Fexp}{\tau} \ssfttm \Fapp{(\FselfCoerce{\tau})}{\Ftyp{\Fexp}{\tau}}
}

\newcommand{\cdIDIntroJ}{
  \axiom{\cdIDIntroJBot}
}

\newcommand{\cdIDIntro}{
  \unnaxiom{\cdIDIntroJBot}
         {cd-idi}
}

\newcommand{\cdIDElimJBot}{
  \Fapp{(\FselfCoerce{\tau})}{\Ftyp{\Fexp}{\tau}} \ssfttm \Ftyp{\Fexp}{\tau}
}

\newcommand{\cdIDElimJ}{
  \axiom{\cdIDElimJBot}
}

\newcommand{\cdIDElim}{
  \unnaxiom{\cdIDElimJBot}
         {cd-ide}
}

\newcommand{\cdComposeIntroJTop}{
  \wfc{\tau_1}{\tau_2}
  \hbump
  \wfc{\tau_2}{\tau_3}
}

\newcommand{\cdComposeIntroJBot}{
  \Fcoerce{\tau_1}{\tau_3}
  \ssfttm 
  \compose{(\Fcoerce{\tau_2}{\tau_3})}{(\Fcoerce{\tau_1}{\tau_2})}     
}

\newcommand{\cdComposeIntroJ}{
  \judgment{\cdComposeIntroJTop}
           {\cdComposeIntroJBot}
}

\newcommand{\cdComposeIntro}{
  \unnjudgment{\cdComposeIntroJTop}
            {\cdComposeIntroJBot}
            {cd-ci}
}

\newcommand{\cdComposeElimJBot}{
  \compose{(\Fcoerce{\tau_2}{\tau_3})}{(\Fcoerce{\tau_1}{\tau_2})} 
  \ssfttm \Fcoerce{\tau_1}{\tau_3}
}

\newcommand{\cdComposeElimJ}{
  \axiom{\cdComposeElimJBot}
}

\newcommand{\cdComposeElim}{
  \unnaxiom{\cdComposeElimJBot}
         {cd-ce}
}

\newcommand{\cdLiftIf}{
  \unnaxiom
  {
    \Ftyp{(\Fif{\Fterm_1}
               {\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_2}}
               {\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_3}})}
         {\tau}
    \ssfttm
    \Ftyp{(\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}
                {(\Fif{\Fterm_1}{\Fterm_2}{\Fterm_3})})}
         {\tau}
  }
  {
    cd-if
  }
}

\newcommand{\cdPair}{
  \unnaxiom
  {
    \Ftyp{\Fpair{\FappP{\Fcoerce{\flt{\tau}_1}{\tau_1}}{\Fterm_1}}
                {\FappP{\Fcoerce{\flt{\tau}_2}{\tau_2}}{\Fterm_2}}}
         {\TPair{\tau_1}{\tau_2}}
    \ssfttm
    \FtypP{\FappP{\Fcoerce{\TPair{\flt{\tau}_1}{\flt{\tau}_2}}{\TPair{\tau_1}{\tau_2}}} 
                 {\Fpair{\Fterm_1}{\Fterm_2}}}
          {\TPair{\tau_1}{\tau_2}}
  }
  {
    cd-pair
  }
}

\newcommand{\cdLiftProjOne}{
  \unnaxiom
  {
    \FtypP{\Fproj{1}{\Fpair{\FappP{\Fcoerce{\flt{\tau}_1}{\tau_1}}{\Fterm_1}}{\Fterm_2}}}
          {\tau_1}
    \ssfttm
    \FtypP{\FappP{\Fcoerce{\flt{\tau}_1}{\tau_1}}{(\Fproj{1}{\Fpair{\Fterm_1}}{\Fterm_2})}}
          {\tau_1}
  }
  {
    cd-fst
  }
}

\newcommand{\cdLiftProjTwo}{
  \unnaxiom
  {
    \FtypP{\Fproj{2}{\Fpair{\Fterm_1}{\FappP{\Fcoerce{\flt{\tau}_2}{\tau_2}}{\Fterm_2}}}}
          {\tau_2}
    \ssfttm
    \FtypP{\FappP{\Fcoerce{\flt{\tau}_2}{\tau_2}}{(\Fproj{2}{\Fpair{\Fterm_1}}{\Fterm_2})}}
          {\tau_2}
  }
  {
    cd-snd
  }
}

\newcommand{\cdLiftApp}{
  \unnaxiom
  {
    \FtypP{\Fapp{(\FappP{\CO{\TFun{\ftau_1}{\ftau_2}}{\TFun{\tau_1}{\tau_2}}}{\Ftm_1})}
                {(\FappP{\CO{\ftau_1}{\tau_1}}{\Ftm_2})}}
          {\tau_2}
    \ssfttm
    \FtypP{\FappP{\CO{\ftau_2}{\tau_2}}{(\Fapp{\Ftm_1}{\Ftm_2})}}{\tau_2}
  }
  {
    cd-app
  }
}

\newcommand{\cdLiftComp}{
  \unnaxiom
  { 
    \begin{array}{l}
      \FtypP{\compose{\FappP{\CO{\TFun{\ftau_2}{\ftau_3}}{\TFun{\tau_2}{\tau_3}}}{\Ftm_1}}
                      {\FappP{\CO{\TFun{\ftau_1}{\ftau_2}}{\TFun{\tau_1}{\tau_2}}}{\Ftm_2}}}
            {\TFun{\tau_1}{\tau_3}} \\
      \quad \ssfttm
      \FtypP{\FappP{\CO{\TFun{\ftau_1}{\ftau_3}}{\TFun{\tau_1}{\tau_3}}}
                   {(\compose{\Ftm_1}{\Ftm_2})}}
            {\TFun{\tau_1}{\tau_3}}
    \end{array}
  }
  {
    cd-comp
  }
}

\newcommand{\cdLiftParr}{
  \unnjudgment
  {
%    (\textrm{same} \ \Fcoerce{\flt{\tau}}{\tau} \ \textrm{applied to all} \ \Fterm_i)
  }
  {
    \Ftyp{\Fparr{\Es{\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_1}}
                    {\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_n}}}}
         {\TParr{\tau}}
    \ssfttm
    \Ftyp{(\Fapp{(\Fcoerce{\TParr{\flt{\tau}}}{\TParr{\tau}})}
                {\Ftyp{\Fparr{\Es{\Fterm_1}{\Fterm_n}}}{\TParr{\flt{\tau}}}})}
         {\TParr{\tau}}
  }
  {
    cd-arr
  }
}

\newcommand{\cdLiftFarr}{
  \unnjudgment
  {
%    (\textrm{same} \ \Fcoerce{\flt{\tau}}{\tau} \ \textrm{applied to all} \ \Fterm_i)
  }
  {
    \Ftyp{\Ffpr{\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_1}, \ldots, \Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_n}}{s}}
         {\TFParr{\tau}{\nu}}
    \ssfttm
    \Ftyp{(\Fapp{(\Fcoerce{\TFParr{\flt{\tau}}{\nu}}{\TFParr{\tau}{\nu}})}{\Ffpr{\Fterm_1. \ldots, \Fterm_n}{s}})}
         {\TFParr{\tau}{\nu}}
  }
  {
    cd-farr
  }
}

\newcommand{\cdLiftLet}{
  \unnaxiom
  {
    \FtypP{\Nlet{x}{\Fterm_1}{\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_2}}}
          {\tau}
    \ssfttm
    \FtypP{\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{(\Nlet{x}{\Fterm_1}{\Fterm_2})}}
          {\tau}
  }
  {
    cd-let
  }
}

\newcommand{\cdLiftFun}{
  \unnaxiom
  {
    \FtypP{\Ffun{f}{x}{\tau}{\Fterm_1}{\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\Fterm_2}}}
          {\tau}
    \ssfttm
    \FtypP{\FappP{\Fcoerce{\flt{\tau}}{\tau}}
                 {(\Ffun{f}{x}{\tau}{\Fterm_1}{\Fterm_2})}}
          {\tau}
  }
  {
    cd-fun
  }
}

\newcommand{\cdSub}{
  \unnjudgment
  {
    \wfc{\tau}{\ftau}
  }
  {
    \FtypP{\Fsub{\tau}{\Fterm_1}{\Fterm_2}}
          {(\select{\tau})}
    \ssfttm
    \FtypP{\Fapp{(\Fcoerce{\select{\ftau}}{\select{\tau}})}
                {\FtypP{\Fsub{\ftau}
                               {(\Fapp{(\Fcoerce{\tau}{\ftau})}{\Fterm_1})}
                               {\Fterm_2}}
                       {(\select{\ftau})}}}
          {(\select{\tau})}
  }
  {
    cd-sub
  }
}

\newcommand{\cdFilt}{
  \unnjudgment
  {
%    \wfc{\tau_2}{\flt{\tau}_2}
%    \hbump
    \relA{\ftau_2}{\tau_1}
  }
  {
    \Ftyp{(\Ffilt{\tau_1}
                 {\tau_2}
                 {\Fterm_1}
                 {\Fterm_2})}
         {\tau_2}
    \ssfttm
    \Ftyp{(\Fapp{(\Fcoerce{\flt{\tau}_2}{\tau_2})}
                {(\Ffilt{\tau_1}
                        {\flt{\tau_2}}
                        {\Fterm_1}
                        {\Fapp{(\Fcoerce{\tau_2}{\flt{\tau}_2})}{\Fterm_2}})})}
         {\tau_2}
  }
  {
    cd-filt
  }
}

\newcommand{\cdMap}{
  \unnjudgment
  {
    \relA{\ftau_3}{\tau_1}
    \hbump
    \relA{\ftau_4}{\tau_2}
  }
  {
    \begin{array}{l}
    \FtypP{\Fmap{\tau_1}{\tau_2}{\tau_3}{\tau_4}{\Fterm_1}{\Fterm_2}}{\tau_4} \\
      \quad \ssfttm
            \FtypP{\FappP{\Fcoerce{\flt{\tau}_4}{\tau_4}}
              {(\Fmap{\tau_1}
                {\tau_2}
                {\ftau_3}
                {\ftau_4}
                {\Ftm_1}
                {\FappP{\CO{\tau_3}{\ftau_3}}{\Ftm_2}})}}
              {\tau_4}
    \end{array}
  }
  {
    cd-map
  }
}

\newcommand{\cdRed}{
  \unnjudgment
  {
    \relA{\ftau_2}{\tau_1}
  }
  {
    \FtypP{\Freduce{\tau_1}{\tau_2}{\Fterm_1}{\Fterm_2}{\Fterm_3}}
          {\tau_1}
    \ssfttm
    \FtypP{\Freduce{\tau_1}
                   {\ftau_2}
                   {\Ftm_1}
                   {\Ftm_2}
                   {\FappP{\CO{\tau_2}{\ftau_2}}{\Ftm_3}}}
          {\tau_1}
  }
  {
    cd-red
  }
}

\newcommand{\cdCtxtJTop}{
  \Ftyp{\Fexp}{\tau} \ssfttm \Ftyp{\flt{\Fexp}}{\tau}
}

\newcommand{\cdCtxtJBot}{
  C[\Ftyp{\Fexp}{\tau}] \ssfttm C[\Ftyp{\flt{\Fexp}}{\tau}]
}

\newcommand{\cdCtxtJ}{
  \judgment{\cdCtxtJTop}
           {\cdCtxtJBot}
}

\newcommand{\cdCtxt}{
  \unnjudgment{\cdCtxtJTop}
            {\cdCtxtJBot}
            {cd-ctxt}
}

\newcommand{\cdVar}{
  \unnjudgment
  {
    \wfc{\ftau}{\tau}
  }
  {
    \Ftyp{\Fvar{x}}{\tau}
    \ssfttm
    \FtypP{\FappP{\CO{\ftau}{\tau}}
                 {\Ftyp{\flt{\Fvar{x}}}{\ftau}}}
          {\tau}
  }
  {
    cd-var
  }
}

\newcommand{\cdLetPropJTop}{
  \wfc{\tau_1}{\flt{\tau}_1}
  \hbump
  \fresh{\flt{x}}
  \hbump
  S = \Fsubst
        {\Ftyp{x}{\tau_1}}
        {\FtypP{\FappP{\CO{\ftau_1}{\tau_1}}
                      {\Ftyp{\flt{\Fvar{x}}}{\ftau_1}}}
               {\tau_1}}
}

\newcommand{\cdLetPropJBot}{
%  \begin{array}{l}
    \FtypP{\Nlet{x}{\Fterm_1}{\Fterm_2}}{\tau_0}
    \ssfttm
          \FtypP{\Nlet{\flt{x}}
                      {\FappP{\CO{\tau_1}{\ftau_1}}{\Fterm_1}}
                      {S \; \Ftm_2}}
                {\tau_0}
%  \end{array}
}

\newcommand{\cdLetPropJ}{
  \judgment{\cdLetPropJTop}
           {\cdLetPropJBot}
}

\newcommand{\cdLetProp}{
  \unnjudgment{\cdLetPropJTop}
            {\cdLetPropJBot}
            {cd-let-prop}
}

\newcommand{\cdFunProp}{
  \unnjudgment
  {
    \begin{array}{c}
      \wfc{\tau_0}{\flt{\tau_0}} \hbump \fresh{\flt{f},\flt{x}} \\
      S = \Fsubst{\Ftyp{f}{\TFun{\tau_0}{\tau_1}}}
                 {\FtypP
                    {\compose
                       {\Ftyp{\flt{\Fvar{f}}}{\TFun{\ftau_0}{\tau_1}}}
                       {(\CO{\tau_0}{\ftau_0})}
                    }
                    {\TFun{\tau_0}{\tau_1}}} \\
                 %%    {\compose
                 %%       {\Ftyp{\flt{f}}{\TFun{\ftau}{\tau_1}}}
                 %%       {(\CO{\tau}{\ftau}})}}
                 %% {X} \\
      S' = S  \Fsubst
                {\Ftyp{x}{\tau_0}}
                {\FtypP{\FappP{\CO{\ftau_0}{\tau_0}}
                              {\Ftyp{\flt{\Fvar{x}}}{\ftau_0}}}
                       {\tau_0}}
%\Fsubst{x}{\Fapp{(\Fcoerce{\flt{\tau}}{\tau})}{\flt{x}}}
    \end{array}
  }
  {
    \FtypP{\Ffun{\Fvar{f}}
                {\Fvar{x}}
                {\tau_0}
                {\Ftm_1}
                {\Ftm_2}}
          {\tau_2}        
    \ssfttm
    \FtypP{\Ffun{\flt{\Fvar{f}}}
                {\flt{\Fvar{x}}}
                {\ftau_0}
                {S' \; \Ftm_1}
                {S \; \Ftm_2}}
          {\tau_2}
  }
  {
    cd-fun-prop
  }
}
